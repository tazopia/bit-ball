<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.thymeleaf.org"
      layout:decorate="layout/mobileLayout" th:with="main='page', gnb='slot', title='슬롯머신'" ng-app="app">
<body ng-controller="gameCtrl">
<div layout:fragment="popup" th:if="true">
    <div id="layout-wrap"></div>
    <div id="layout-load" class="loading"></div>
</div>

<main class="page" layout:fragment="page">
    <div class="box casino-box">
        <h4 style="font-size:16px; margin-bottom: 10px;">
            슬롯머니 :
            {{ balance | number: 0 }} 원
        </h4>
        <div style="margin-left: auto">
            <a class="btn btn01" ng-click="casino();">새로고침</a>
        </div>
    </div>
    <div class="command">
        <a class="btn-big btn03" ng-click="receive();">환전하기</a>
    </div>

    <h3>슬롯 머니 충전</h3>
    <div class="wrap">
        <label>
            <span>금액선택</span>
            <input type="text" class="num" ng-model="amount" ng-change="changeAmount()"/>
        </label>
    </div>
    <div class="amount">
        <a class="btn" ng-click="setAmount(10000);">만원</a>
        <a class="btn" ng-click="setAmount(30000);">삼만원</a>
        <a class="btn" ng-click="setAmount(50000);">오만원</a>
        <a class="btn" ng-click="setAmount(70000);">칠만원</a>
        <a class="btn" ng-click="setAmount(100000);">십만원</a>
        <a class="btn" ng-click="setAmount(300000);">삼십만원</a>
        <a class="btn" ng-click="setAmount(500000);">오십만원</a>
        <a class="btn" ng-click="setAmount(700000);">칠십만원</a>
        <a class="btn" ng-click="setAmount(1000000);">백만원</a>
        <a class="btn btn02" ng-click="resetAmount();">정정</a>
    </div>
    <div class="command">
        <a class="btn-big btn03" ng-click="send();">충전하기</a>
    </div>

    <div class="slotTitle">◎ Global Slot Games ◎</div>
    <br/><br/>
    <div class="casino-games">
        <div class="casino-game">
            <div class="casino-title">프라그마틱</div>
            <div class="slot-body">
                <img src="/images/slot/pragmaticplay.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('PragmaticPlay', '프라그마틱')">슬롯목록</button>
            </div>
        </div>
        <div class="casino-game">
            <div class="casino-title">CQ9</div>
            <div class="slot-body">
                <img src="/images/slot/cq9.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('CQ9', 'CQ9')">슬롯목록</button>
            </div>
        </div>
        <div class="casino-game">
            <div class="casino-title">에보플레이</div>
            <div class="slot-body">
                <img src="/images/slot/evoplay.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('EVOPLAY', '에보플레이')">슬롯목록</button>
            </div>
        </div>
        <div class="casino-game">
            <div class="casino-title">하바네로</div>
            <div class="slot-body">
                <img src="/images/slot/habanero.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('Habanero', '하바네로')">슬롯목록</button>
            </div>
        </div>
        <div class="casino-game">
            <div class="casino-title">플레이스타</div>
            <div class="slot-body">
                <img src="/images/slot/playstar.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('PlayStar', '플레이스타')">슬롯목록</button>
            </div>
        </div>
        <div class="casino-game">
            <div class="casino-title">TPG</div>
            <div class="slot-body">
                <img src="/images/slot/tpg.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('Triple Profit Gaming', 'TPG')">슬롯목록</button>
            </div>
        </div>
        <div class="casino-game">
            <div class="casino-title">분고</div>
            <div class="slot-body">
                <img src="/images/slot/booongo.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('Booongo', '분고')">슬롯목록</button>
            </div>
        </div>
        <div class="casino-game">
            <div class="casino-title">블루프린트</div>
            <div class="slot-body">
                <img src="/images/slot/blueprint.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('Blueprint Gaming', '블루프린트 게이밍')">슬롯목록</button>
            </div>
        </div>
        <div class="casino-game">
            <div class="casino-title">Wazdan</div>
            <div class="slot-body">
                <img src="/images/slot/wazdan.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('Wazdan', 'Wazdan')">슬롯목록</button>
            </div>
        </div>
        <div class="casino-game">
            <div class="casino-title">릴렉스 게이밍</div>
            <div class="slot-body">
                <img src="/images/slot/relax.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('Relax Gaming', '릴렉스 게이밍')">슬롯목록</button>
            </div>
        </div>
        <div class="casino-game">
            <div class="casino-title">게임아트</div>
            <div class="slot-body">
                <img src="/images/slot/gameart.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('GameArt', '게임아트')">슬롯목록</button>
            </div>
        </div>
        <div class="casino-game">
            <div class="casino-title">플레이 앤 고</div>
            <div class="slot-body">
                <img src="/images/slot/playngo.png">
            </div>
            <div class="casino-cmd">
                <button class="btn btn01" ng-click="showGame('PlayNGo', '플레이 앤 고')">슬롯목록</button>
            </div>
        </div>
        <!--        <div class="casino-game">-->
        <!--            <div class="casino-title">YGG</div>-->
        <!--            <div class="slot-body">-->
        <!--                <img src="/images/slot/yggdrasil.png">-->
        <!--            </div>-->
        <!--            <div class="casino-cmd">-->
        <!--                <button class="btn btn01" ng-click="showGame('YGG', 'YGG')">슬롯목록</button>-->
        <!--            </div>-->
        <!--        </div>-->
    </div>
    <br/><br/>

    <div id="slotGame"></div>
    <div ng-if="game != ''" id="slot-game">
        <div class="slotTitle">◎ {{ game }} ◎</div>
        <br/><br/>
        <div class="slot-games">
            <div class="casino-game" ng-repeat="slot in slots" ng-click="goGame(slot.id, slot.provider)">
                <div class="casino-title">{{slot.title}}</div>
                <div class="casino-body">
                    <img ng-src="{{slot.thumbnail}}">
                </div>
            </div>
        </div>
    </div>
    <br/><br/><br/>

</main>

<script layout:fragment="script" th:if="true">
    angular.module('app', []).controller('gameCtrl', ['$scope', '$http', '$interval', '$timeout', function ($scope, $http, $interval, $timeout) {
        $scope.money = 0;
        $scope.amount = 0;
        $scope.amount2 = 0;
        $scope.balance = 0;
        $scope.point = 0;
        $scope.token = '[[${token.token}]]';
        $scope.action = false;
        $scope.game = '';
        $scope.slots = [];
        $scope.allSlot = [(${slot})];

        $scope.$watch('$viewContentLoaded', function () {
            $scope.setInfo();
            $scope.casino();
            $timeout(function () {
                $('#layout-wrap, #layout-load').fadeOut(function () {
                    $('#layout-wrap, #layout-load').hide();
                });
            })
        });

        $interval(function () {
            $scope.setInfo();
            $scope.casino();
        }, 5000);

        $scope.setInfo = function () {
            $http({
                url: path + '/api/info',
                method: 'POST',
                headers: {
                    'Content-type': 'application/json',
                    'Ajax': true
                }
            }).then(function success(response) {
                $scope.money = response.data.money;
                angular.element('#user-memo').text(response.data.memo.toString().money());
                angular.element('#user-money').text(response.data.money.toString().money());
                angular.element('#user-point').text(response.data.point.toString().money());
            }, function error(response) {
                if (response.status === 401 || response.status === 403) {
                    top.location.href = '/logout';
                }
            });
        };

        $scope.casino = function () {
            $http({
                url: path + '/casino/evolution/user',
                method: 'POST',
                headers: {
                    'Content-type': 'application/json',
                    'Ajax': true
                }
            }).then(function success(response) {
                $scope.balance = response.data.balance;
                $scope.point = response.data.point;
            });
        };

        $scope.send = function () {
            if ($scope.action) return;

            $scope.action = true;

            if ($scope.amount < 10000) {
                alert('최소 전환 머니는 10,000원 이상입니다.');
                $scope.amount = 0;
                $scope.action = false;
                return;
            }

            if ($scope.amount > $scope.money) {
                alert('전환할수 있는 최대 보유머니는 ' + $scope.money.toString().money() + '원 입니다.');
                $scope.amount = 0;
                $scope.action = false;
                return;
            }

            angular.element('#layout-wrap').css('display', 'block');
            angular.element('#layout-load').css('display', 'block');

            $http({
                url: path + '/casino/evolution/send',
                method: 'post',
                headers: {
                    'Content-type': 'application/json',
                    'Ajax': true
                },
                data: {
                    "money": $scope.amount,
                    "casinoId": '[[${casinoId}]]'
                }
            }).then(function success(response) {
                if (response.data.success) {
                    alert(response.data.message);
                    $scope.casino();
                } else {
                    alert(response.data.message);
                    //alert('머니 이동에 실패하였습니다.\n\n잠시 후 다시 이용하세요.')
                }
                $scope.amount = 0;
                angular.element('#layout-wrap').css('display', 'none');
                angular.element('#layout-load').css('display', 'none');
                $scope.action = false;
            }, function error(response) {
                angular.element('#layout-wrap').css('display', 'none');
                angular.element('#layout-load').css('display', 'none');
                $scope.action = false;
            });
        }

        $scope.receive = function () {
            if ($scope.action) return;

            $scope.action = true;

            if ($scope.amount2 === 0) {
                alert('환전할 머니가 없습니다.');
                $scope.action = false;
                $scope.amount2 = 0;
                return;
            }

            if ($scope.amount2 > $scope.balance) {
                alert('환전할 수 있는 최대 머니는 ' + $scope.balance.toString().money() + '원 입니다.');
                $scope.action = false;
                $scope.amount2 = 0;
                return;
            }

            angular.element('#layout-wrap').css('display', 'block');
            angular.element('#layout-load').css('display', 'block');

            $http({
                url: path + '/casino/evolution/receive',
                method: 'post',
                headers: {
                    'Content-type': 'application/json',
                    'Ajax': true
                },
                data: {
                    "money": $scope.amount2,
                    "casinoId": '[[${casinoId}]]'
                }
            }).then(function success(response) {
                if (response.data.success) {
                    $scope.balance = 0;
                    alert(response.data.message);
                } else {
                    alert(response.data.message);
                    //alert('머니 환전에 실패하였습니다.\n\n잠시 후 다시 이용하세요.')
                }
                $scope.amount2 = 0;
                angular.element('#layout-wrap').css('display', 'none');
                angular.element('#layout-load').css('display', 'none');
                $scope.action = false;
            }, function error(response) {
                angular.element('#layout-wrap').css('display', 'none');
                angular.element('#layout-load').css('display', 'none');
                $scope.action = false;
            });
        }

        $scope.exchange = function () {
            if ($scope.point === 0) {
                alert('전환할 적립 포인트가 없습니다.');
                return;
            }

            angular.element('#layout-wrap').css('display', 'block');
            angular.element('#layout-load').css('display', 'block');

            $http({
                url: path + '/casino/evolution/exchange',
                method: 'post',
                headers: {
                    'Content-type': 'application/json',
                    'Ajax': true
                },
                data: {
                    "casinoId": '[[${casinoId}]]'
                }
            }).then(function success(response) {
                $scope.balance = response.data.balance;
                $scope.point = response.data.point;
                alert('포인트를 머니로 전환하였습니다.');

                angular.element('#layout-wrap').css('display', 'none');
                angular.element('#layout-load').css('display', 'none');
            }, function error(response) {
                alert('포인트 전환에 실패하였습니다.');

                angular.element('#layout-wrap').css('display', 'none');
                angular.element('#layout-load').css('display', 'none');
            });
        }

        $scope.setAmount = function (amount) {
            $scope.amount += amount;
            angular.element('#amountKor').text(amount <= 0 ? '' : '(' + $.num2han(amount) + ' 원)');
        }

        $scope.resetAmount = function () {
            $scope.amount = 0;
            angular.element('#amountKor').text('');
        }

        $scope.changeAmount = function () {
            angular.element('#amountKor').text($scope.amount <= 0 ? '' : '(' + $.num2han($scope.amount) + ' 원)');
        }

        $scope.setAmount2 = function (amount) {
            $scope.amount2 += amount;
            if (amount === 0) {
                $scope.amount2 = $scope.balance;
            }
            angular.element('#amountKor2').text(amount <= 0 ? '' : '(' + $.num2han(amount) + ' 원)');
        }

        $scope.resetAmount2 = function () {
            $scope.amount2 = 0;
            angular.element('#amountKor2').text('');
        }

        $scope.changeAmount2 = function () {
            angular.element('#amountKor2').text($scope.amount2 <= 0 ? '' : '(' + $.num2han($scope.amount2) + ' 원)');
        }

        $scope.goGame = function (id, provider) {
            $http({
                url: path + '/casino/evolution/token',
                method: 'post',
                headers: {
                    'Content-type': 'application/json',
                    'Ajax': true
                }
            }).then(function success(response) {
                window.open('[[${game}]]?provider=' + provider + '&id=' + id + '&token=' + response.data.token, 'slot', 'width=1500, height=900');
            }, function error(response) {
                alert('슬롯 입장에 실패하였습니다.');
            });
        }

        $scope.showGame = function (vendor, title) {
            $scope.game = title;
            $scope.slots = $scope.allSlot.filter(x => x.vendor === vendor);
            var location = document.getElementById('slotGame').offsetTop;
            setTimeout(function () {
                window.scrollTo({top: location, behavior: 'smooth'});
            }, 100);
        }

    }]);
</script>
</body>
</html>